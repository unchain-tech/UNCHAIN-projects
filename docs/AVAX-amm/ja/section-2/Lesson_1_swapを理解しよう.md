### 🐣 swap の仕組みを理解しましょう

AMM ではアルゴリズムに従って swap できるトークンの量を決定します。  
ここでは Uniswap と同様に式$k = y * x$を使用します。

y は流動性プールにある一方のトークン Y の量, x は他方のトークン X の量です。

k は固定定数です。  
つまり, プールにある双方のトークン量の積は常に一定です。

⚠️ 実際には, 流動性の提供時や swap 時に手数料を考慮すると k は変化しますが,  
あくまで$k = y * x$の法則に基づいてトークンの価格を算出しています。

$k = y * x$の式を図にすると以下のような曲線を描きます。

![](/public/images/AVAX-amm/section-2/2_1_1.png)

x の量が増えるほど y の量が減り, y の量が増えるほど x の量は減るような式になっています。

つまりトークン X から Y へ swap する場合は, ユーザからプールへ X の送信がありプール内に X の量が増えるので,
プール内の Y の量は減らします。  
減らした分の Y の量をユーザへ送信することで swap が完了します。

今の処理を図で見てみましょう。  
トークン X から Y への swap 時, プール内のトークンの量の変化は下の図の A 地点->B 地点への移動で表すことができます。

![](/public/images/AVAX-amm/section-2/2_1_2.png)

逆にトークン Y から X への swap は以下のように考えられます。

![](/public/images/AVAX-amm/section-2/2_1_3.png)

このように AMM の内部では$k = y * x$に基づいて価格決定をしています。

X->Y への swap が続きプール内に X の量が増えるだけ, 同じ X の量で swap できる Y の量は減ります。  
X の価値は下がり Y の価値は上がります。

### 🏛️ swap で得られるトークン量の計算式を導き出しましょう。

ここからは, AMM コントラクトがユーザの swap 要求に対してどのような計算式を使えば,  
swap によりユーザに送信するトークンの量を算出できるかを考えます。

もしわかりにくい場合は一度先に進んでコードを実装してみて, 再度このレッスンに戻ってくると理解しやすくなっているかもしれません。  
Discord の `#avax-amm` で聞くのも良いでしょう。  
また, 間違っている部分がありましたら[こちら](https://github.com/shiftbase-xyz/UNCHAIN-projects/issues)にプルリクエストを送って頂けると大変助かりますのでよろしくお願い致します。

それでは以下の状況について swap 時に使用する計算式を導きます。

プール内に, `トークンX` と `トークンY` の量がそれぞれ x と y あるとします。

ユーザは `トークンX` を投入し, `トークンY` を受け取る状況を考えます。(X -> Y への swap)

この時, 投入する `トークンX` の量を x', 受け取る `トークンY` の量を y' で表すことにします。

🦕 シチュエーション 1: x' から y' を算出する

![](/public/images/AVAX-amm/section-2/2_1_2.png)

プールに入る x' の量が分かっていて, x' を元にプールから出る量 y' を算出する方法を導きます。

基本式は以下で, K は定数というものでした。

$$k = y * x$$

つまり x' と y' 分の増減があってもプールに残る X と Y の積は一定ということです。  
これを式にすると以下のようになります。

$$xy = (x+x')(y-y')$$

式の左辺が上図の A 地点, 右辺が上図の B 地点の K を表しています。
さらに今回求めたい y' について上の式を解いていきます。

$$
\begin{align}
xy &=(x+x')(y-y')\\
y-y' &= \frac{xy}{x+x'}\\
\end{align}
$$

$$
\begin{align}
y' &= y - \frac{xy}{x+x'}\\
&= \frac{y(x+x') - xy}{x+x'}\\
&= \frac{xy+x'y - xy}{x+x'}\\
&= \frac{x'y}{x+x'}
\end{align}
$$

シンプルな式が導き出されました。  
この計算式を利用することで y' を求めることができます。

🐬 シチュエーション 2: y' から x' を算出する

図はシチュエーション 1 と同じものです。

![](/public/images/AVAX-amm/section-2/2_1_2.png)

ここでは先ほどとは逆に, プールから出る量 y' があらかじめ指定された状態で, どのくらいの量の x' をプールに入れなければいけないのかを求めます。

計算は先ほどとほとんど同じで, 今度は x' について解きます。

$$
\begin{align}
xy &=(x+x')(y-y')\\
x+x' &= \frac{xy}{y-y'}\\
\end{align}
$$

$$
\begin{align}
x' &= \frac{xy}{y-y'} - x\\
&= \frac{xy - x(y-y')}{y-y'}\\
&= \frac{xy - xy + xy'}{y-y'}\\
&= \frac{xy'}{y-y'}\\
\end{align}
$$

以上でユーザが swap をする際に, swap 元のトークンの量から受け取れる swap 先のトークンの量を求めたい時はシチュエーション 1 の式を,  
swap によって受け取りたい swap 先のトークンの量からどのくらい swap 元のトークンが必要かを求めたい時はシチュエーション 2 の式を利用すれば良いことがわかりました。

### 🙋‍♂️ 質問する

ここまでの作業で何かわからないことがある場合は,Discord の `#avax-amm` で質問をしてください。

ヘルプをするときのフローが円滑になるので,エラーレポートには下記の 3 点を記載してください ✨

```
1. 質問が関連しているセクション番号とレッスン番号
2. 何をしようとしていたか
3. エラー文をコピー&ペースト
4. エラー画面のスクリーンショット
```

swap について理解をしたところで,次のレッスンで swap 時の手数料についても理解を深めましょう 🎉
