---
title: ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ä½œæˆã—ã‚ˆã†
---
### ğŸ‘©â€ğŸ’» å®Ÿè£…ã™ã‚‹å†…å®¹ã®ç¢ºèª

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½œæˆã™ã‚‹dappã®å†…å®¹ã‚’æ•´ç†ã—ã¾ã™ã€‚

éŠ€è¡Œã®è¡Œã£ã¦ã„ã‚‹æ‰‹å½¢å–å¼•ã‚’ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§ç®¡ç†ã™ã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

æ‰‹å½¢å–å¼•ã¨ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

![](/images/AVAX-Subnet/section-2/1_2_1.png)

æ‰‹å½¢ã®ç™ºè¡Œè€…ã¨å—å–äººã€ä»²ä»‹äººã¨ã—ã¦ã®éŠ€è¡ŒãŒã„ã‚‹çŠ¶æ…‹ã§ä»¥ä¸‹ã®ã‚ˆã†ãªå–å¼•ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

1. ã‚ã‚‹äº‹æ¥­è€…ã®é–“ã§å•†å“ã®å–å¼•ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã“ã“ã§å•†å“ã®è²·ã„æ‰‹ãŒãã®å ´ã§ä»£é‡‘ã‚’ç”¨æ„ã§ããªã„å ´åˆã«æ‰‹å½¢ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚å•†å“ã®è²·ã„æ‰‹ã‚’æ‰‹å½¢ç™ºè¡Œè€…ã€å£²ã‚Šæ‰‹ãŒå—å–äººã¨ã—ã¾ã™ã€‚
2. ç™ºè¡Œè€…ã¯ã™ãã«ã¯ä»£é‡‘ã‚’æ”¯æ‰•ãˆãªã„ãŸã‚ã«ã€æœŸé™ãŒæ¥ãŸã‚‰ç¾é‡‘ã¨äº¤æ›ã™ã‚‹ã“ã¨ãŒã§ãã‚‹æ‰‹å½¢ã‚’å—å–äººã«å¯¾ã—ã¦ç™ºè¡Œã—ã¾ã™ã€‚
3. å—å–äººã¯æ‰‹å½¢ã‚’éŠ€è¡Œã«æŒã£ã¦ã„ãã¾ã™ã€‚
4. éŠ€è¡Œã¯æ‰‹å½¢ã‚’ç¾é‡‘ã¨äº¤æ›ã—å—å–äººã¸æ¸¡ã—ã¾ã™ã€‚ã“ã®æ™‚ã€æ‰‹å½¢ã®æœŸé™ã«é”ã—ã¦ã„ãªã„å ´åˆã¯æœ¬æ¥ã®é‡‘é¡ã‹ã‚‰å‰²ã‚Šå¼•ã„ãŸé‡‘é¡ã‚’å—å–äººã«æ¸¡ã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
5. éŠ€è¡Œã¯æœŸé™ã«é”ã—ãŸæ‰‹å½¢ã«å¯¾ã—ã¦ç™ºè¡Œè€…ã«è«‹æ±‚ã—ã¾ã™ã€‚
6. ç™ºè¡Œè€…ã¯æ‰‹å½¢ã®é‡‘é¡ã¨æ‰‹æ•°æ–™ã‚’éŠ€è¡Œã«æ”¯æ‰•ã„ã¾ã™ã€‚
7. æœŸé™ã¾ã§ã«æ‰‹å½¢ã®æ”¯æ‰•ã„ã‚’è¡Œã‚ãªã‹ã£ãŸç™ºè¡Œè€…ã¯ä¸æ¸¡ã‚Šã‚’èµ·ã“ã—ãŸäº‹æ¥­è€…ã¨ãªã‚Šå–å¼•ãŒã§ããªããªã‚Šã¾ã™ã€‚

ä»¥ä¸Šã®ä»•çµ„ã¿ã‚’ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«å®Ÿè£…ã—ã¾ã™ã€‚

ç™ºè¡Œè€…ã¨å—å–äººãŒãƒ¦ãƒ¼ã‚¶ã¨ã—ã¦å­˜åœ¨ã—ã€ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒéŠ€è¡Œã®å½¹ç›®ã‚’æœãŸã—ã¾ã™ã€‚

ä»£é‡‘ã«ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### ğŸ¥¦ æ—¢å­˜é‡‘èã¨ Subnet

ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã¯é€æ˜æ€§ã‚„æ”¹ã–ã‚“è€æ€§ã‹ã‚‰ã€éŠ€è¡Œãªã©ã®æ—¢å­˜é‡‘èã«ã¨ã£ã¦ãƒ¡ãƒªãƒƒãƒˆã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨è¨€ãˆã¾ã™ã€‚

ã¾ãŸã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãªã©ã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ç®¡ç†æ¥­å‹™ã‚’è‡ªå‹•åŒ–ã§ãã‚‹ç‚¹ã‚‚ãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚

ã—ã‹ã—ä¼æ¥­ã®é‹å–¶ã«ã¯ä¸æ­£ãªæ´»å‹•ã‚’ã™ã‚‹äº‹æ¥­è€…ã‚’æ’é™¤ã™ã‚‹è²¬ä»»ã‚„åˆ©ç”¨è€…ã¸ã®èª¬æ˜è²¬ä»»ãªã©ãŒä¼´ã†ãŸã‚ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã‚’ä½¿ã†å ´åˆã¯ã‚ã‚‹ç¨‹åº¦ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å¯¾ã—ã¦ã§ãã‚‹çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚‚æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

Subnetã§ã¯,ã€Œè¨±å¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®å±•é–‹ã‚„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€ã¨è¦æ±‚ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
è¨±å¯ãƒªã‚¹ãƒˆã¯ç®¡ç†è€…ã«ã‚ˆã£ã¦ã®ã¿æ›´æ–°ã•ã‚Œã€è¨±å¯ãƒªã‚¹ãƒˆè‡ªä½“ã¯PreCompileã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå†…ã«å®Ÿè£…ã•ã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã«é–¢ã™ã‚‹äº‹é …ã«ã¤ã„ã¦ã¯ã‚ˆã‚Šé€æ˜ã§ç›£æŸ»ãŒå¯èƒ½ã§ã™ã€‚

### ğŸ¥® `Bank`ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

`section1`ã®ã“ã‚Œã‹ã‚‰å…ˆã®ä½œæ¥­ã¯ã€`AVAX-Subnet/packages/contract`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã—ã¦è©±ã‚’é€²ã‚ã¾ã™ã€‚ ğŸ™Œ

`contracts`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã«`Bank.sol`ã¨ã„ã†åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

Hardhatã‚’ä½¿ç”¨ã™ã‚‹å ´åˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã¯éå¸¸ã«é‡è¦ã§ã™ã®ã§ã€æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ãŒä¸‹è¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚Œã°å¤§ä¸ˆå¤«ã§ã™ ğŸ˜Š

```
contract
â””â”€â”€ contracts
    â””â”€â”€ Bank.sol
```

æ¬¡ã«ã€ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’é–‹ãã¾ã™ã€‚

`Bank.sol`ã®ä¸­ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

contract Bank {
    // æ‰‹å½¢ã®å±æ€§ã§ã™ã€‚
    struct Bill {
        uint256 id;
        uint256 amount;
        uint256 timestamp;
        address issuer;
        address recipient;
        BillStatus status;
    }

    // æ‰‹å½¢ã®çŠ¶æ…‹ã‚’è¡¨ã—ã¾ã™ã€‚
    enum BillStatus {
        Issued,    // ç™ºè¡Œã•ã‚ŒãŸ
        Paid,      // æ”¯æ‰•ã‚ã‚ŒãŸ
        Cashed,    // ç¾é‡‘åŒ–ã•ã‚ŒãŸ
        Completed, // æ­£å¸¸ã«å‡¦ç†ã•ã‚ŒãŸ
        Dishonored // ä¸æ¸¡ã‚Šã¨ãªã£ãŸ
    }

    // å…¨ã¦ã®æ‰‹å½¢ã‚’ä¿å­˜ã—ã¾ã™ã€‚
    Bill[] public allBills;

    // ä¸æ¸¡ã‚Šã‚’èµ·ã“ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜ã—ã¾ã™ã€‚
    address[] public dishonoredAddresses;

    // å„ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ãƒ­ãƒƒã‚¯ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®æ•°ã‚’ä¿æœ‰ã—ã¾ã™ã€‚
    mapping(address => uint256) private _balance;

    // æ‰‹å½¢ã®æœŸé–“ã‚’å®šæ•°ã§ç”¨æ„ã—ã¾ã™ã€‚
    uint256 public constant TERM = 1 days * 60;

    // å‰²å¼•é‡‘åˆ©
    uint256 public constant DISCOUNT_RATE = 10;

    // æ‰‹å½¢æ‰‹æ•°æ–™
    uint256 public constant INTEREST_RATE = 10;

    constructor() payable {}
}
```

ã‚‚ã—,`hardhat.config.ts`ã®ä¸­ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹Solidityã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ`0.8.17`ã§ãªã‹ã£ãŸå ´åˆã¯,`Bank.sol`ã®ä¸­èº«ã‚’`hardhat.config.ts`ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚

ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå†’é ­ã§ã¯Billï¼ˆæ‰‹å½¢ï¼‰ã®å±æ€§ã‚’ã‚ã‚‰ã‚ã™structã‚„çŠ¶æ…‹ã‚’è¡¨ã™enumãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãã®ä¸‹ã«çŠ¶æ…‹å¤‰æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

`_balance`: ç™ºè¡Œè€…ãŒæ‰‹å½¢ã®é‡‘é¡ã‚’ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«æ”¯æ‰•ã£ãŸéš›ã«ãã®é‡‘é¡ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

`DISCOUNT_RATE`: æœŸé™ã«é”ã—ã¦ã„ãªã„æ‰‹å½¢ã‚’å—å–äººãŒç¾é‡‘åŒ–ã™ã‚‹éš›ã«ã€10ï¼…å‰²å¼•ã§ç¾é‡‘åŒ–ã—ã¾ã™ã€‚

`INTEREST_RATE`: ç™ºè¡Œè€…ãŒæ‰‹å½¢ã®æ”¯æ‰•ã„ã‚’ã™ã‚‹éš›ã¯ã€æ‰‹å½¢ã®ä»£é‡‘ã®10ï¼…ã‚’æ‰‹æ•°æ–™ã¨ã—ã¦ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«æ”¯æ‰•ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`Bank`ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã¯ã‚ã‚‹ç¨‹åº¦ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã—ãŸã„ãŸã‚ã€constructorã«ã¯`payable`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

æ¬¡ã«`Bank`ã®æœ€å¾Œã®è¡Œã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚

```solidity
    function _sendToken(address payable _to, uint256 _amount) private {
        (bool success, ) = (_to).call{value: _amount}("");
        require(success, "Failed to send token");
    }

    function getNumberOfBills() public view returns (uint256) {
        return allBills.length;
    }

    function getNumberOfDishonoredAddresses() public view returns (uint256) {
        return dishonoredAddresses.length;
    }

    function getBalance() public view returns (uint256) {
        return _balance[msg.sender];
    }

    function beforeDueDate(uint256 _id) public view returns (bool) {
        Bill memory bill = allBills[_id];

        if (block.timestamp <= bill.timestamp + TERM) {
            return true;
        } else {
            return false;
        }
    }

    function getAmountToCashBill(uint256 _id) public view returns (uint256) {
        Bill memory bill = allBills[_id];

        if (beforeDueDate(_id)) {
            return (bill.amount * (100 - DISCOUNT_RATE)) / 100;
        }

        return bill.amount;
    }

    function getAmountToPayBill(uint256 _id) public view returns (uint256) {
        Bill memory bill = allBills[_id];
        return (bill.amount * (100 + DISCOUNT_RATE)) / 100;
    }
```

`_sendToken`ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒˆãƒ¼ã‚¯ãƒ³ã‚’\_toã¸\_amountåˆ†é€ä¿¡ã™ã‚‹é–¢æ•°ã§ã™ã€‚

`beforeDueDate`ã¯ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨æ‰‹å½¢ã®æœŸé™ã‚’æ¯”è¼ƒã—ã¦ã€æœŸé™ã«é”ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’è¿”å´ã—ã¾ã™ã€‚

> ğŸ““ `block.timestamp`ã®ä½¿ç”¨ã«ã¤ã„ã¦
> ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§æ™‚é–“ã®å‚ç…§æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚
> `block.timestamp`ã¯ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹éš›ã«ã€ãƒãƒªãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã£ã¦æ“ä½œãŒã§ãã‚‹ã¨ã„ã†æ‡¸å¿µç‚¹ãŒã‚ã‚Šã¾ã™ãŒã€æ“ä½œã®ã§ãã‚‹ç¯„å›²ã¯ 30 ç§’ã»ã©ã§ã™ã€‚
> ã¤ã¾ã‚Š 30 ç§’ã®ç¯„å›²ã§å®Ÿéš›ã¨ã¯å·®ã®ã‚ã‚‹æ™‚é–“ã‚’ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå†…ã®ãƒ­ã‚¸ãƒƒã‚¯ã«ä½¿ç”¨ã—ã¦ã‚‚è‰¯ã„ã®ãªã‚‰`block.timestamp`ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
> ä»Šå›ã¯ç°¡æ˜“çš„ãªå®Ÿè£…ãªã®ã§ã“ã¡ã‚‰ã‚’ä½¿ã„ã¾ã™ã€‚
> Ethereum ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§ã¯ã€`block.number`ã‚’ä½¿ç”¨ã—ãŸæ–¹æ³•([å‚è€ƒ](https://zoom-blc.com/solidity-time-logic))ãªã©ã‚‚ã‚ã‚Šã¾ã™ãŒã€Avalanche ã§ã¯å®šæœŸçš„ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ã¨ã„ã†ä»•çµ„ã¿ã§ã¯ãªã„ãŸã‚ã“ã¡ã‚‰ã¯ä½¿ç”¨ã§ããªãã†ã§ã™ã€‚
> æ­£ç¢ºãªæƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã¯ã‚ªãƒ©ã‚¯ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`getAmountToCashBill`ã¯ã€å—å–äººãŒæ‰‹å½¢ã‚’ç¾é‡‘åŒ–ã™ã‚‹éš›ã«å®Ÿéš›ã«ç¾é‡‘åŒ–ã•ã‚Œã‚‹é‡‘é¡ã‚’è¿”å´ã™ã‚‹ã‚‚ã®ã§ã™ã€‚
æ‰‹å½¢ã®æœŸé™å‰ã§ã‚ã‚‹å ´åˆã¯å‰²å¼•ã—ãŸé‡‘é¡ã‚’è¿”å´ã—ã¾ã™ã€‚

`getAmountToPayBill`ã¯ã€ç™ºè¡Œè€…ãŒæ‰‹å½¢ã®æ”¯æ‰•ã„ã‚’è¡Œã†éš›ã«å®Ÿéš›ã«æ‰•ã†é‡‘é¡ã‚’è¿”å´ã—ã¾ã™ã€‚
æ‰‹æ•°æ–™ã®åˆ†å‰²å¢—ã—ãŸé‡‘é¡ã‚’è¿”å´ã—ã¾ã™ã€‚

æ¬¡ã«`Bank`ã®æœ€å¾Œã®è¡Œã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚

```solidity
    function issueBill(uint256 _amount, address _recipient) public {
        Bill memory bill = Bill(
            allBills.length,
            _amount,
            block.timestamp, // block.timestampã¯æ­£ç¢ºãªå€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
            msg.sender,
            _recipient,
            BillStatus.Issued
        );

        allBills.push(bill);
    }

    function cashBill(uint256 _id) public payable {
        Bill storage bill = allBills[_id];

        require(
            bill.status == BillStatus.Issued || bill.status == BillStatus.Paid,
            "Status is not Isued or Paid"
        );

        require(bill.recipient == msg.sender, "Your are not recipient");

        bill.status = BillStatus.Cashed;

        uint256 amount = getAmountToCashBill(_id);

        _sendToken(payable(msg.sender), amount);
    }

    function lockToken(uint256 _id) public payable {
        Bill storage bill = allBills[_id];
        uint256 amount = getAmountToPayBill(_id);

        require(msg.value == amount, "Amount is not correct");

        bill.status = BillStatus.Paid;

        _balance[msg.sender] += msg.value;
    }

    function completeBill(uint256 _id) public payable {
        Bill storage bill = allBills[_id];

        require(
            bill.status == BillStatus.Issued ||
                bill.status == BillStatus.Cashed ||
                bill.status == BillStatus.Paid,
            "Bill is already completed"
        );

        require(!beforeDueDate(_id), "Before due date");

        uint256 amount = getAmountToPayBill(_id);

        if (amount <= _balance[bill.issuer]) {
            _balance[bill.issuer] -= amount;
            bill.status = BillStatus.Completed;
        } else {
            bill.status = BillStatus.Dishonored;
            dishonoredAddresses.push(bill.issuer);
        }
    }
```

`issueBill`: ç™ºè¡Œè€…ãŒä½¿ç”¨ã—ã¾ã™ã€‚\_recipientï¼ˆå—å–äººï¼‰ã«å¯¾ã—ã¦\_amountï¼ˆãƒˆãƒ¼ã‚¯ãƒ³é‡ï¼‰åˆ†ã®æ‰‹å½¢ã®ç™ºè¡Œã‚’è¡Œã„ã¾ã™ã€‚

`cashBill`: å—å–äººãŒä½¿ç”¨ã—ã¾ã™ã€‚æŒ‡å®šã—ãŸidã®Billã‚’ç¾é‡‘åŒ–ã—ã¾ã™ã€‚

`lockToken`: ç™ºè¡Œè€…ãŒæ‰‹å½¢ã®æ”¯æ‰•ã„ã«ä½¿ç”¨ã—ã¾ã™ã€‚é€ä»˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³é‡ã‚’`_balance`ã«è¨˜éŒ²ã—ã¾ã™ã€‚

`completeBill`: éŠ€è¡Œã®ç®¡ç†è€…ãŒåˆ©ç”¨ã—ã¾ã™ã€‚æœŸé™ã«é”ã—ãŸBillã‚’å‡¦ç†ã—ã¾ã™ã€‚ç™ºè¡Œè€…ãŒæ‰‹å½¢ã®é‡‘é¡åˆ†ã‚’ç´ã‚ã¦ã„ãªã„å ´åˆã¯æ‰‹å½¢ã®çŠ¶æ…‹ã‚’ä¸æ¸¡ã‚Šã¨ã—ã€ç™ºè¡Œè€…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’`dishonoredAddresses`ã«è¿½åŠ ã—ã¾ã™ã€‚

### ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹

ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’å®Ÿè£…ã—ãŸã®ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯è©³ç´°ãªèª¬æ˜ã‚’æŒŸã¾ãªã„ã§ã™ãŒã€ã‚³ãƒ¼ãƒ‰è‡ªä½“ã¯é‡ãŒå¤šã„ã®ã§ã“ã¡ã‚‰ã«è¼‰ã›ãšã«Git hubä¸Šã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦é ‚ã“ã†ã‹ã¨æ€ã„ã¾ã™ã€‚

`test`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã«`Bank.ts`ã‚’ä½œæˆã—ã€[ã“ã¡ã‚‰](https://github.com/unchain-tech/AVAX-Subnet/blob/main/contract/test/Bank.ts)ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚

ã¾ãŸã€å…ˆã«å‚è€ƒæ–‡çŒ®ã‚’ç´¹ä»‹ã—ã¾ã™ã®ã§ã“ã®å…ˆã®èª¬æ˜ã§ã‚ã‹ã‚‰ãªã„æ™‚ã¯å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

ğŸ’ hardhatã§è¡Œã†ãƒ†ã‚¹ãƒˆã®è¨˜è¿°æ–¹æ³•ã«é–¢ã—ã¦ã¯[ã“ã¡ã‚‰](https://hardhat.org/hardhat-runner/docs/guides/test-contracts)ã€‚

ğŸ’ ãƒ•ã‚¡ã‚¤ãƒ«å†’é ­ã«`chai`ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰`expect`ã‚’importã—ã¦ã„ã¾ã™ã€‚`expect`ã®ä½¿ã„æ–¹ã«é–¢ã—ã¦ã¯[ã“ã¡ã‚‰](https://hardhat.org/hardhat-chai-matchers/docs/reference)ã€‚

ğŸ’ ãƒ•ã‚¡ã‚¤ãƒ«å†’é ­ã«`hardhat-network-helpers`ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰`loadFixture`ã¨`time`ã‚’importã—ã¦ã„ã¾ã™ã€‚ãã‚Œãã‚Œä½¿ã„æ–¹ã«é–¢ã—ã¦ã¯[ã“ã¡ã‚‰](https://hardhat.org/hardhat-network-helpers/docs/reference)ã€‚

ãã‚Œã§ã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€å„ãƒ†ã‚¹ãƒˆã§å‘¼ã³å‡ºã•ã‚Œã‚‹`deployContract`ã¨ãã®å¾Œã«ç¶šããƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```ts
describe("Bank", function () {
  enum BillStatus {}
  // status

  async function getLastBlockTimeStamp() {
    // æœ€å¾Œã«è¨˜éŒ²ã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿”å´
  }

  async function deployContract() {
    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤
  }

  // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
});
```

`deployContract`å†…ã§ã¯ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ä½œæ¥­ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
è¿”ã‚Šå€¤ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä½¿ç”¨ã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ãã®ä»–ã«ä½¿ç”¨ã§ãã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®é–¢æ•°ã¯å„ãƒ†ã‚¹ãƒˆã§æœ€åˆã«å‘¼ã°ã‚Œã¾ã™ã€‚

æ¬¡ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§`issueBill`ã«é–¢ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```ts
describe("issueBill", function () {
  it("Correct bill issued.", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    // Billã®ç™ºè¡Œ
    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    // ç™ºè¡Œã•ã‚ŒãŸBillã®å–å¾—
    const bill = await bank.allBills(newId);

    // ç™ºè¡Œã•ã‚ŒãŸBillã®å†…å®¹ã®ç¢ºèª
    expect(bill.id).to.equal(newId);
    expect(bill.amount).to.equal(amount);
    expect(bill.timestamp).to.equal(await getLastBlockTimeStamp());
    expect(bill.issuer).to.equal(issuer.address);
    expect(bill.recipient).to.equal(recipient.address);
    expect(bill.status).to.equal(BillStatus.Issued);
  });
});
```

æ¬¡ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§`cashBill`ã«é–¢ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚
å„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```ts
describe("cashBill", function () {
  it("Token is transferred correctly.", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    // Billã®ç™ºè¡Œ
    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    // ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã®æ™‚é–“ã‚’æ‰‹å½¢ã®æœŸé™åˆ†é€²ã‚ã¾ã™ã€‚
    const term = await bank.TERM();
    await time.increase(term);

    // æœŸé™ã«é”ã—ãŸæ‰‹å½¢ã‚’ç¾é‡‘åŒ–ã—ãŸéš›ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ãç§»å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(
      bank.connect(recipient).cashBill(newId)
    ).to.changeEtherBalances([bank, recipient], [-amount, amount]);
  });

  it("Discounted amount of token is transferred correctly.", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    const discountRate = await bank.DISCOUNT_RATE();
    const discountedAmount = amount.sub(amount.mul(discountRate).div(100));

    // Billã®ç™ºè¡Œ
    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    // æœŸé™ã«é”ã—ã¦ã„ãªã„æ‰‹å½¢ã‚’ç¾é‡‘åŒ–ã—ãŸéš›ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ãç§»å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(
      bank.connect(recipient).cashBill(newId)
    ).to.changeEtherBalances(
      [bank, recipient],
      [-discountedAmount, discountedAmount]
    );
  });

  it("Revert if call twice.", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    // Billã®ç™ºè¡Œ
    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    // cashBillã‚’é€£ç¶šã§å‘¼ã³å‡ºã—ãŸæ™‚,ï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒå†åº¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã—ã¦ã—ã¾ã‚ãšã«)2åº¦ç›®ã®cashBillã®å‘¼ã³å‡ºã—ãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    await bank.connect(recipient).cashBill(newId);
    await expect(bank.connect(recipient).cashBill(newId)).to.be.reverted;
  });

  it("Revert if different user call.", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    // Billã®ç™ºè¡Œ
    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    // å—å–äººã§ãªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹cashBillã®å‘¼ã³å‡ºã—ãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(bank.connect(issuer).cashBill(newId)).to.be.reverted;
  });
});
```

æ¬¡ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§`lockToken`ã«é–¢ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```ts
describe("lockToken", function () {
  it("Token is transferred correctly.", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    const interestRate = await bank.INTEREST_RATE();
    const amountWithFee = amount.add(amount.mul(interestRate).div(100));

    // ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ãç§»å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(
      bank.connect(issuer).lockToken(newId, {
        value: amountWithFee,
      } as Overrides)
    ).to.changeEtherBalances([issuer, bank], [-amountWithFee, amountWithFee]);

    // statusã¨ã€balanceã«æ­£ã—ããƒˆãƒ¼ã‚¯ãƒ³é‡ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect((await bank.allBills(newId)).status).to.equal(BillStatus.Paid);
    expect(await bank.connect(issuer).getBalance()).to.equal(amountWithFee);
  });
});
```

æœ€å¾Œã«ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§`completeBill`ã«é–¢ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```ts
describe("completeBill", function () {
  it("Revert if call before due date", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    // Billã®ç™ºè¡Œ
    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    // æœŸé™ã«é”ã—ã¦ã„ãªã„Billã¯å‡¦ç†ã§ãã¾ã›ã‚“ã€‚
    await expect(bank.completeBill(newId)).to.be.reverted;
  });

  it("Bill is properly completed", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    // Billã®ç™ºè¡Œ
    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    const interestRate = await bank.INTEREST_RATE();
    const amountWithFee = amount.add(amount.mul(interestRate).div(100));

    // æ‰‹å½¢ã®æ”¯æ‰•ã„
    await bank.connect(issuer).lockToken(newId, {
      value: amountWithFee,
    } as Overrides);

    // ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã®æ™‚é–“ã‚’æ‰‹å½¢ã®æœŸé™åˆ†é€²ã‚ã¾ã™ã€‚
    const term = await bank.TERM();
    await time.increase(term);

    // æ‰‹å½¢ã®å‡¦ç†
    await bank.completeBill(newId);

    // balanceã¨statusã®ç¢ºèª
    expect(await bank.connect(issuer).getBalance()).to.equal(0);
    expect((await bank.allBills(newId)).status).to.equal(BillStatus.Completed);
  });

  it("Bill is properly dishonored.", async function () {
    const { bank, userAccounts } = await loadFixture(deployContract);

    const issuer = userAccounts[0];
    const recipient = userAccounts[1];
    const amount = BigNumber.from(100);

    // æ‰‹å½¢ã®ç™ºè¡Œ
    await bank.connect(issuer).issueBill(amount, recipient.address);
    const newId = 0;

    // ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã®æ™‚é–“ã‚’æ‰‹å½¢ã®æœŸé™åˆ†é€²ã‚ã¾ã™ã€‚
    const term = await bank.TERM();
    await time.increase(term);

    // æ‰‹å½¢ã®å‡¦ç†
    await bank.completeBill(newId);

    // balanceã¨statusã®ç¢ºèª
    // (ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã®æ™‚é–“ã¯æ‰‹å½¢ã®æœŸé™åˆ†çµŒã£ã¦ã„ã‚‹ã®ã§ã€statusãŒä¸æ¸¡ã‚Šã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª)
    expect((await bank.allBills(newId)).status).to.equal(BillStatus.Dishonored);
    expect(await bank.dishonoredAddresses(0)).to.equal(issuer.address);
  });
});
```

### â­ ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```
yarn test
```

ä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºãŒã•ã‚Œã¾ã™ã€‚
å®Ÿè¡Œã—ãŸãƒ†ã‚¹ãƒˆåã¨ãã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](/images/AVAX-Subnet/section-2/1_2_2.png)

### ğŸŒ” å‚è€ƒãƒªãƒ³ã‚¯

> [ã“ã¡ã‚‰](https://github.com/unchain-tech/AVAX-Subnet)ã«æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Œæˆå½¢ã®ãƒ¬ãƒã‚¸ãƒˆãƒªãŒã‚ã‚Šã¾ã™ã€‚
> æœŸå¾…é€šã‚Šå‹•ã‹ãªã„å ´åˆã¯å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

### ğŸ™‹â€â™‚ï¸ è³ªå•ã™ã‚‹

ã“ã“ã¾ã§ã®ä½œæ¥­ã§ä½•ã‹ã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã‚‹å ´åˆã¯ã€Discordã®`#avalanche`ã§è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚

ãƒ˜ãƒ«ãƒ—ã‚’ã™ã‚‹ã¨ãã®ãƒ•ãƒ­ãƒ¼ãŒå††æ»‘ã«ãªã‚‹ã®ã§ã€ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã«ã¯ä¸‹è¨˜ã®3ç‚¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ âœ¨

```
1. è³ªå•ãŒé–¢é€£ã—ã¦ã„ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ã¨ãƒ¬ãƒƒã‚¹ãƒ³ç•ªå·
2. ä½•ã‚’ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã‹
3. ã‚¨ãƒ©ãƒ¼æ–‡ã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ
4. ã‚¨ãƒ©ãƒ¼ç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
```

---

å°‘ã—é•·ã„ãƒ¬ãƒƒã‚¹ãƒ³ã§ã—ãŸãŒãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼

ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸ ğŸ”¥

